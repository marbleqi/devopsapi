# 技术方案

## 数据库

Postgres

## 缓存

Redis

## 使用到的框架功能

- 守卫
- 拦截器
- 自定义装饰器
- 配置
- 控制器
- 服务
- 网关
- 队列
- TypeOrm
- 事件

## 请求方法

- 读操作使用 Get 方法
- 写操作使用 Post 方法
- 删除操作使用 Delete 方法

注：参考 docker 以及 Kubernetes 的 API 接口规范

## 守卫

使用全局守卫，在守卫逻辑中，对除了登陆模块和通知模块外的其他模块做身份认证和权限认证
并创建请求日志记录，获取请求 ID（剩响应状态码，响应数据和请求结束时间不填）

## 拦截器

使用全局拦截器，对所有的请求处理完成后，更新请求日志记录

注：更新补充当前请求日志的响应状态码，响应数据和请求结束时间

## 控制器

使用 DTO 类做请求传入参数的验证，如果验证不通过，直接通过验证器抛出异常（状态码一般为 400）

读操作路由，使用方法为 Get，传参使用 Param 或 Query

如果读操作只有两个，列表和详情，
列表路径使用：对象名称
详情路径使用：对象名称/对象 ID

如果读操作有多个，如列表，详情，日志，查询等
多个对象的操作路径：对象名称/操作类型
单个对象的操作路径：对象名称/对象 ID/操作类型
如：
列表路径使用：对象名称/index
查询路径使用：对象名称/search
详情路径使用：对象名称/对象 ID/show
更新日志路径使用：对象名称/对象 ID/log

写操作路由

写操作在服务中的方法返回值，统一为 Result，及操作结果

创建操作路径：对象名称/create
更新操作路径：对象名称/对象 ID/update
启动操作路径：对象名称/对象 ID/start
停止操作路径：对象名称/对象 ID/stop
重启操作路径：对象名称/对象 ID/restart

## 服务

做具体的业务数据处理，并对所有成功的写操作，记录实体对象的变更日志

# 实体类设计（Typeorm 中的 Entity）

即对具体业务对象的设计

## 通用实体基类

字段包括更新人，更新时间，操作 ID，请求 ID

## 对象实体基类

继承自通用实体基类，并增加在对象实体类和对象实体日志类中都存在的字段

## 对象实体类

继承自对象实体基类，并增加对象实体表的主键字段，以及一些不保存到对象实体日志表中的字段（比如一经创建就不再更新的数据等）

## 对象实体日志表

继承自对象实体基类，并增加对象实体日志表的主键字段，

# 语法规范

类名使用大驼峰命名法，变量名使用小驼峰命名法
同一个实体如果存在多个 DTO，则将这些 DTO 写在同一个文件中
