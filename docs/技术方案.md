# 技术方案

## 数据库

Postgres

## 缓存

Redis

## 使用到的框架功能

- 守卫
- 拦截器
- 自定义装饰器
- 配置
- 控制器
- 服务
- 网关
- 队列
- TypeOrm
- 事件

## 请求方法

- 读操作使用 Get 方法
- 写操作使用 Post 方法
- 删除操作使用 Delete 方法

注：参考 docker 以及 Kubernetes 的 API 接口规范

## 守卫

使用全局守卫，在守卫逻辑中，对除了登陆模块和通知模块外的其他模块做身份认证和权限认证
并创建请求日志记录，获取请求 ID（剩响应状态码，响应数据和请求结束时间不填）

## 拦截器

使用全局拦截器，对所有的请求处理完成后，更新请求日志记录

注：更新补充当前请求日志的响应状态码，响应数据和请求结束时间

## 控制器

使用 DTO 类做请求传入参数的验证，如果验证不通过，直接通过验证器抛出异常（状态码一般为 400）

读操作路由，使用方法为 Get，传参使用 Param 或 Query

如果读操作只有两个，列表和详情，
列表路径使用：对象名称
详情路径使用：对象名称/对象 ID

如果读操作有多个，如列表，详情，日志，查询等
多个对象的操作路径：对象名称/操作类型
单个对象的操作路径：对象名称/对象 ID/操作类型
列表路径使用：对象名称/index
查询路径使用：对象名称/search
详情路径使用：对象名称/对象 ID/show
更新日志路径使用：对象名称/对象 ID/log

写操作路由

写操作在服务中的方法返回值，统一为 Result，及操作结果

创建操作路径：对象名称/create
更新操作路径：对象名称/对象 ID/update
启动操作路径：对象名称/对象 ID/start
停止操作路径：对象名称/对象 ID/stop
重启操作路径：对象名称/对象 ID/restart

## 服务

做具体的业务数据处理，并对所有成功的写操作，记录实体对象的变更日志

# 实体类设计（Typeorm 中的 Entity）

即对具体业务对象的设计

## 通用的动态接口

包括更新人，更新时间，更新操作 ID

## 通用的静态接口

包括创建人，创建时间

## 具体实体的动态接口

根据具体的业务实体来定，指创建后会可改变的属性
如用户的首次登录时间等

## 具体实体的静态接口

根据具体的业务实体来定，指创建后会不可改变的属性
如用户的最近登陆时间等

## 表设计

所有实体对象都有两个表，实体表（记录实体当前状态）和日志表（记录实体的变更历史）。
实体表中的字段实现所有接口（通用动态接口，通用静态接口，实体类动态接口，实体类静态接口）
实体日志表中的字段实现所有动态接口（通用动态接口，实体类动态接口）

## 语法规范

类名使用大驼峰命名法，变量名使用小驼峰命名法
同一个实体的 DTO 写在同一个文件中

## 控制器

读操作路由，使用方法为 Get，传参使用 Param 或 Query

如果读操作只有两个：列表，详情

- 列表路径使用：对象名称
- 详情路径使用：对象名称/对象 ID

如果读操作有多个，如列表，详情，日志，查询等

- 多个对象的操作路径：对象名称/操作类型
- 单个对象的操作路径：对象名称/对象 ID/操作类型
- 列表路径使用：对象名称/index
- 查询路径使用：对象名称/search
- 详情路径使用：对象名称/对象 ID/show
- 更新日志路径使用：对象名称/对象 ID/log

写操作路由

写操作在服务中的方法返回值，统一为 Result，即操作结果（因为操作可能失败）

- 创建操作路径：对象名称/create
- 更新操作路径：对象名称/对象 ID/update
- 启动操作路径：对象名称/对象 ID/start
- 停止操作路径：对象名称/对象 ID/stop
- 重启操作路径：对象名称/对象 ID/restart
